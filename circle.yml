machine:
  services:
    - docker

general:
  artifacts:
    - ~/results
    - ~/rpc_results

dependencies:
  override:
    - sudo apt-get update
    - sudo apt-get install pandoc
    - pip install awscli codecov
    # AWS and docker and circleci do not get along well:
    # for safety, try both ways of assigning credentials
    - |
      login="$(aws ecr get-login)"
      ${login}
      login="$(aws ecr get-login --no-include-email)"
      ${login}
    - docker pull $TESTRUNNER_DOCKER_IMAGE
    - pip install tox tox-pyenv
    - pyenv local 2.7.12 3.6.2
    - tox --notest
  cache_directories:
    - ".tox"

test:
  pre:
    - echo '{"api_key":"$MBED_CLOUD_API_KEY", "host":"$MBED_CLOUD_API_HOST"}' > .mbed_cloud_config.json
    - cat .mbed_cloud_config.json
  override:
    - tox
  post:
    # upload to codecov.io
    - codecov

deployment:
  production:
    branch: master
    commands:
      - ./generate-docs.sh
